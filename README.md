# PDF Reader / Table Extractor (php)

Инструмент для извлечения структурированного содержимого (текстовые блоки + таблицы) из PDF без внешних бинарных зависимостей.  
Фокус: «правильные» таблицы с реконструкцией логической структуры и нормализацией колонок (убираем placeholder и пустые суффиксы вроде `c_2`).

## Возможности

- Парсинг страниц: текстовые фрагменты с координатами (bbox, baseline).
- Детекция таблиц по линиям/сетке и/или по выравниванию текста (text mode).
- Реконструкция матрицы таблицы `raw_matrix` + ассоциативные строки `rows_assoc`.
- Нормализация структуры столбцов:
  - Схлопывание дубликатов заголовков (`a`, `a` → один `a`).
  - Перелив данных из временных/placeholder колонок (`""`, `col_3`) в ближайшие настоящие заголовки.
  - Удаление всех placeholder (`""`, `col_N`).
  - Удаление полностью пустых суффиксных дублей `base_N` (например `c_2` если у нее все значения пусты и есть колонка `c`).
- Приведение значений ячеек к типам (int / float) через `Value::cast` (без потери ведущих нулей).
- Запуск как CLI скрипт; работает даже без Composer (fallback автолоадер).
- Формирование JSON результата.

## Структура результата (упрощённо)

```jsonc
[
  {
    "type": "text",
    "data": "UAH",
    "params": { "...": "..." }
  },
  {
    "type": "table",
    "headers": ["a","b","c"],
    "rows_assoc": [
      {"a":11,"b":33,"c":55},
      {"a":22,"b":44,"c":66}
    ],
    "params": {
      "headers": ["a","b","c"],
      "raw_matrix": [
        ["a","b","c"],
        ["11","33","55"],
        ["22","44","66"]
      ],
      "column_centers": [ ... ],
      "bbox": { "x1":..., "y1":..., ... }
    }
  }
]
```

Колонки вида `c_2` очищаются нормализатором и в итог не попадают (если полностью пустые).  
Placeholder (`col_1`, `col_3`, пустые заголовки) удаляются всегда.

## Установка / запуск

### Вариант 1. Без Composer (минимум)

1. Склонируйте/скачайте проект.
2. Убедитесь, что в `bin/run.php` есть fallback автолоад (он уже есть).
3. Запустите:
   ```bash
   php bin/run.php --file=sample.pdf --debug
   ```
4. JSON сохранится рядом с PDF (имя `sample.json`) и выведется в stdout (если не отключено).

### Вариант 2. С Composer (рекомендуется для расширения)

1. Инициализировать (если нет):
   ```bash
   composer init
   ```
2. Добавить в `composer.json`:
   ```json
   {
     "autoload": { "psr-4": { "ParserPDF\\": "src/" } }
   }
   ```
3. Выполнить:
   ```bash
   composer dump-autoload
   ```
4. Запуск:
   ```bash
   php bin/run.php --file=sample.pdf --debug
   ```

`bin/run.php` сначала пытается подключить `vendor/autoload.php`, в случае отсутствия — включает встроенный PSR‑4 автолоадер.

## Основные файлы

| Файл | Назначение |
|------|------------|
| `bin/run.php` | CLI вход, парсинг аргументов, запуск `ParserPDF` |
| `src/ParserPDF.php` | Координация разбора PDF и сбор компонентов |
| `src/Tables/TextTableDetector.php` | Выделение таблиц из текстовых фрагментов (линейная логика/анализ колонок) |
| `src/Tables/TableStructureNormalizer.php` | Нормализация структуры столбцов (включая удаление `c_2`) |
| `src/Util/Value.php` | Приведение строк ячеек к числовым типам (без потери ведущих нулей) |
| `src/Util/Log.php` (опц.) | Простой логгер (если включите) |

## Нормализация столбцов (алгоритм кратко)

1. Формирует список колонок (заголовок + массив значений).
2. Итеративно:
   - Перелив из placeholder → именованную (если паттерн пусто/непусто).
   - Перелив в обратную сторону (если именованная пустая, placeholder заполнен).
   - Схлопывание подряд идущих одинаковых заголовков.
3. Глобальная консолидация дубликатов (не только подряд).
4. Поячейковый «долив» данных из оставшихся placeholder в ближайшую справа именованную (если та ячейка пустая).
5. Удаление всех placeholder колонок.
6. Финальная очистка: суффиксные `base_N` удаляются, если все значения пустые и есть базовый `base`.
7. Пересборка `headers`, `raw_matrix`, `rows_assoc`, `cells`, центров колонок.

Результат: максимум по одному столбцу на логическое имя, никаких `col_N`, никаких пустых `c_2` и т.п.

### Почему отдельная очистка суффиксов?

Некоторые PDF генераторы создают «лишнюю» невидимую колонку (фрейм/спан), попадающую как `c_2` без содержимого. Логика чистки распознаёт это как пустой дубль реального `c` и удаляет.

## Приведение значений (`Value::cast`)

Примеры:
- `"11"` → `11` (int)
- `"0011"` → `"0011"` (строка, сохраняем ведущие нули)
- `"12,34"` / `"12.34"` → `12.34` (float)
- Длинные числа > 18 цифр → строка
- Пустая строка → `""`

(Можно легко добавить опцию `disable_casting` для полного отключения типизации — при необходимости создайте issue/запрос).

## CLI опции

| Опция | Пример | Описание |
|-------|--------|----------|
| `--file` | `--file=report.pdf` | (обяз.) входной PDF |
| `--debug` | `--debug` | Доп. лог (stderr) |
| `--no-save` | `--no-save` | Не сохранять JSON файл |
| `--no-stdout` | `--no-stdout` | Не печатать JSON в stdout |
| `--out` | `--out=out/result.json` | Путь сохранения |
| любые `--ключ=значение` | `--disable_casting=true` | Пробрасываются в `$options` (можно использовать в будущем) |

## Примеры запуска

```bash
php bin/run.php --file=examples/simple.pdf
php bin/run.php --file=examples/simple.pdf --debug --out=build/output.json
php bin/run.php --file=examples/simple.pdf --no-save > result.json
```

## Частые вопросы (FAQ)

**Q:** Почему всё ещё вижу `c_2`?  
**A:** Проверь что используешь обновлённый `TableStructureNormalizer.php`. Если да — убедись, что нормализация вызывается перед финальной сборкой компонентов. В debug можно добавить временный вывод `var_dump($table['headers'])` до/после.

**Q:** Как отключить числовое приведение?  
**A:** Добавь в код вызова опцию `['disable_casting'=>true]` и передавай её вторым параметром в `Value::cast`.

**Q:** Можно ли сохранить bbox каждого cell?  
**A:** Да — нужно хранить их из исходного детектора и не перегенерировать `cells` с `bbox=null`. Сейчас упрощено.

## Планируемые улучшения

- Опция `preserve_placeholders` (сохранение служебных колонок).
- Распознавание объединённых ячеек (rowspan/colspan).
- Детекция валюты (привязка таблицы к ближайшему верхнему метке «UAH»/«USD»).
- Конфигурируемые стратегии нормализации.
- Юнит‑тесты (PHPUnit) для краевых шаблонов таблиц.

## Разработка

1. Включи `--debug` чтобы видеть промежуточные шаги.
2. Для быстрого логирования можешь добавить `src/Util/Log.php` и использовать `Log::d(null,"msg")`.
3. Pull Request / патчи: придерживайся PSR‑12 (или упрощённо — минимально выровненный стиль).